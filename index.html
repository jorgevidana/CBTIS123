<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Examen - CBTIS 123 - Unidad 3 (Datos y Algoritmos)</title>
    <style>
        body{font-family: Inter,system-ui,Arial;max-width:900px;margin:18px auto;padding:14px; background-color: #f4f4f9;}
        header{display:flex;justify-content:space-between;align-items:center; border-bottom: 2px solid #ccc; padding-bottom: 10px;}
        h2 { color: #1e40af; }
        .card{background-color: white; border:1px solid #ddd; padding:18px; border-radius:12px; margin:15px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
        button{padding:10px 15px; border-radius:8px; border:none; background:#1e40af; color:white; font-weight: bold; cursor: pointer; transition: background 0.3s ease;}
        button:hover { background: #1d4ed8; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .small{font-size:0.85rem; color:#4b5563; margin-top: 5px;}
        .question{margin:15px 0; border-left: 4px solid #3b82f6; padding-left: 10px;}
        .option{display:block; margin:8px 0; padding: 5px; border-radius: 4px; cursor: pointer; transition: background 0.2s;}
        .option:hover { background-color: #eff6ff; }
        input[type="text"]{padding:10px; border-radius:8px; border:1px solid #ccc; width:95%; margin-top: 5px; box-sizing: border-box;}
        input[type="radio"] { margin-right: 8px; }
        #status{margin-top:12px; font-weight: 500;}
        #result h3 { color: #059669; }
        /* Iframe oculto para el método Anti-CORS */
        #hiddenIframe { display: none; } 
    </style>
</head>
<body>
    <header>
        <h2>Examen - Cultura Digital (Unidad 3)</h2>
        <div class="small">Temas: Datos, Algoritmos, Operadores y Diagramas de Flujo</div>
    </header>

    <div class="card">
        <label>Nombre del alumno (o matrícula):</label>
        <input id="studentName" placeholder="Ej. Juan Pérez - 123456" />
        <div class="small">Código de especialidad (Logística, Programación, etc.):</div>
        <input id="accessCode" placeholder="Código ÚNICO de especialidad (Ej. PROG01)" />
    </div>

    <div class="card">
        <div class="small">Instrucciones:</div>
        <ol>
            <li>Inserta tu nombre/matrícula y tu código de especialidad.</li>
            <li>Presiona <b>Iniciar examen</b> para cargar 20 preguntas aleatorias.</li>
            <li>No recargues la página durante el examen.</li>
        </ol>
        <button id="startBtn">Iniciar examen</button>
        <div id="status" class="small"></div>
    </div>

    <form id="examForm" style="display:none"></form>

    <div id="result" class="card" style="display:none"></div>
        <iframe id="hiddenIframe" name="hiddenIframe" style="display:none;"></iframe>

    <script>
        // ---------- CONFIGURACIÓN -------------------------------------------------
        const TOTAL_PER_EXAM = 20; 

        // URL del Web App de Google Apps Script (Mantenemos la URL que proporcionaste)
        const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyxM_bCNhwXCHH9aqu6dTkq97_E5F90jOlTCntcXhvNygsf4uAoqytdTxNl5H3Z-r4VGw/exec';

        const TIME_LIMIT_MINUTES = 0; 

        // BATERÍA COMPLETA DE PREGUNTAS (30 PREGUNTAS) - UNIDAD 3
        const QUESTIONS = [
            // -------------------- DATOS E INFORMACIÓN --------------------
            {id:'U3_001', question:'¿Qué es un dato?', choices:['Un conjunto de datos organizados y procesados','Un hecho o valor sin procesar','Un resultado final de un algoritmo','Un programa de computadora'], answer:1}, // Un hecho o valor sin procesar
            {id:'U3_002', question:'¿Qué es la información?', choices:['Un dato sin significado','Un error en un programa','Datos procesados que tienen significado','Una variable del sistema'], answer:2}, // Datos procesados que tienen significado
            {id:'U3_003', question:'¿Cuál de los siguientes es un ejemplo de dato?', choices:['El promedio de calificaciones','Un reporte escolar','La edad de un alumno: 16','Una gráfica estadística'], answer:2}, // La edad de un alumno: 16
            
            // -------------------- VARIABLES Y CONSTANTES --------------------
            {id:'U3_004', question:'¿Qué es una variable en computación?', choices:['Un valor que nunca cambia','Un símbolo que representa un valor que puede cambiar','Un operador matemático','Un diagrama de flujo'], answer:1}, // Un símbolo que representa un valor que puede cambiar
            {id:'U3_005', question:'¿Cuál es un ejemplo de constante?', choices:['La calificación de un examen','La edad de una persona','El valor de $\\pi$ (3.1416)','El número de alumnos en un grupo'], answer:2}, // El valor de π (3.1416)
            {id:'U3_006', question:'¿Para qué se usan las expresiones?', choices:['Para combinar valores y obtener un resultado','Para almacenar datos sin procesar','Para dibujar diagramas','Para iniciar un programa'], answer:0}, // Para combinar valores y obtener un resultado
            {id:'U3_007', question:'¿Cuál de los siguientes ejemplos es una expresión?', choices:['edad','5 + 3 * 2','Inicio','Fin'], answer:1}, // 5 + 3 * 2

            // -------------------- OPERADORES --------------------
            {id:'U3_008', question:'¿Cuál de los siguientes es un operador aritmético?', choices:['&&','>','=','+'], answer:3}, // +
            {id:'U3_009', question:'¿Qué operador se utiliza para comparar si dos valores son iguales?', choices:['==','+','*','/'], answer:0}, // ==
            {id:'U3_010', question:'¿Cuál es un operador lógico?', choices:['>=','-','OR','*'], answer:2}, // OR
            {id:'U3_011', question:'¿Qué resultado puede producir un operador lógico (AND, OR, NOT)?', choices:['Un número decimal','Verdadero o falso','Un texto largo','Una imagen'], answer:1}, // Verdadero o falso
            {id:'U3_012', question:'¿Qué operador se usa para indicar que un valor es mayor o igual que otro?', choices:['<=','==','!=','>='], answer:3}, // >=
            
            // -------------------- ALGORITMOS --------------------
            {id:'U3_013', question:'¿Qué es un algoritmo?', choices:['Un programa terminado','Una secuencia ordenada de pasos para resolver un problema','Un dato almacenado','Una expresión matemática'], answer:1}, // Una secuencia ordenada de pasos para resolver un problema
            {id:'U3_014', question:'¿Cuál es una característica fundamental de un algoritmo?', choices:['Debe ser ambiguo','No tiene orden','Debe ser claro y finito','Solo se usa en computadoras'], answer:2}, // Debe ser claro y finito
            {id:'U3_015', question:'¿Cuál es el primer paso para crear un algoritmo?', choices:['Ejecutarlo','Dibujar el diagrama','Definir el problema','Escribir el código'], answer:2}, // Definir el problema
            {id:'U3_016', question:'Un algoritmo que no termina nunca se considera:', choices:['Finito','Claro','Ambiguo','Infinito (no válido)'], answer:3},
            
            // -------------------- DIAGRAMAS DE FLUJO --------------------
            {id:'U3_017', question:'¿Para qué sirve un diagrama de flujo?', choices:['Para almacenar datos','Para representar gráficamente un algoritmo','Para escribir código directamente','Para ejecutar programas'], answer:1}, // Para representar gráficamente un algoritmo
            {id:'U3_018', question:'¿Qué figura se usa para indicar el **inicio y el fin** en un diagrama de flujo?', choices:['Rectángulo','Rombo','Paralelogramo','Óvalo'], answer:3}, // Óvalo
            {id:'U3_019', question:'¿Qué figura representa una **decisión** o condición (SI/NO)?', choices:['Óvalo','Rectángulo','Rombo','Paralelogramo'], answer:2}, // Rombo
            {id:'U3_020', question:'¿Qué figura se utiliza para **asignar valores a variables o realizar una operación** (Proceso)?', choices:['Paralelogramo','Rombo','Óvalo','Rectángulo'], answer:3}, // Rectángulo
            {id:'U3_021', question:'¿Qué figura representa una **entrada o salida de datos** (input/output)?', choices:['Rombo','Rectángulo','Óvalo','Paralelogramo'], answer:3}, // Paralelogramo
            {id:'U3_022', question:'Las flechas en un diagrama de flujo indican:', choices:['El tipo de dato','La dirección del flujo de ejecución','El resultado final','El nombre de las variables'], answer:1}, // La dirección del flujo de ejecución

            // -------------------- REFUERZO Y RELACIÓN DE CONCEPTOS --------------------
            {id:'U3_023', question:'Un dato que ya fue procesado y organizado se convierte en (V/F): La información.', choices:['Verdadero','Falso'], answer:0}, // Verdadero
            {id:'U3_024', question:'Una constante puede cambiar su valor durante la ejecución de un programa (V/F).', choices:['Verdadero','Falso'], answer:1}, // Falso
            {id:'U3_025', question:'El símbolo `*` se clasifica como un operador de comparación (V/F).', choices:['Verdadero','Falso'], answer:1}, // Falso (es aritmético)
            {id:'U3_026', question:'Todo algoritmo debe ser preciso, definido y finito (V/F).', choices:['Verdadero','Falso'], answer:0}, // Verdadero
            {id:'U3_027', question:'El operador lógico AND requiere que ambas condiciones sean verdaderas para que el resultado sea verdadero (V/F).', choices:['Verdadero','Falso'], answer:0}, // Verdadero
            {id:'U3_028', question:'El rectángulo es la figura utilizada para representar una decisión en un diagrama de flujo (V/F).', choices:['Verdadero','Falso'], answer:1}, // Falso (es el rombo)
            {id:'U3_029', question:'La secuencia de pasos en un algoritmo puede ser aleatoria (V/F).', choices:['Verdadero','Falso'], answer:1}, // Falso (debe ser ordenada)
            {id:'U3_030', question:'La expresión `A != B` significa que A es diferente de B (V/F).', choices:['Verdadero','Falso'], answer:0} // Verdadero
        ];

        // ----------------- LÓGICA -------------------------------------------------
        const startBtn = document.getElementById('startBtn');
        const examForm = document.getElementById('examForm');
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');

        function shuffle(a){
            for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}
            return a
        }

        function selectRandomQuestions(all, n){
            const copy = all.slice();
            shuffle(copy);
            return copy.slice(0, Math.min(n, copy.length));
        }

        function renderExam(questions){
            examForm.innerHTML='';
            questions.forEach((q, idx)=>{
                const div = document.createElement('div'); div.className='question card';
                // Manejo especial para el valor de Pi (matemáticas)
                let questionText = q.question;
                if (q.id === 'U3_005') {
                    questionText = questionText.replace('$\\pi$', 'π');
                }
                div.innerHTML = `<strong>Pregunta ${idx+1}.</strong> <div>${escapeHtml(questionText)}</div>`;
                
                // barajar opciones
                const choices = q.choices.map((c,i)=>({i,c}));
                shuffle(choices);
                choices.forEach(ch=>{
                    const id = `q${idx}_opt${ch.i}`;
                    const label = document.createElement('label'); label.className='option';
                    label.innerHTML = `<input type="radio" name="q${idx}" value="${ch.i}" /> ${escapeHtml(ch.c)}`;
                    div.appendChild(label);
                });
                examForm.appendChild(div);
            });

            const submitBtn = document.createElement('button'); submitBtn.type='button'; submitBtn.textContent='Enviar examen';
            submitBtn.onclick = submitExam;
            examForm.appendChild(submitBtn);
            examForm.style.display='block';
        }

        function escapeHtml(text){return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

        function gatherAnswers(questions){
            const answers = [];
            for(let i=0;i<questions.length;i++){
                const radios = document.getElementsByName(`q${i}`);
                let chosen = null;
                for(const r of radios) if(r.checked) chosen = parseInt(r.value);
                answers.push({questionId: questions[i].id, chosen: chosen});
            }
            return answers;
        }

        function computeScore(questions, answers){
            let correct=0; const detail=[];
            for(let i=0;i<questions.length;i++){
                const q = questions[i];
                const a = answers[i].chosen;
                const isCorrect = (a === q.answer);
                if(isCorrect) correct++;
                detail.push({id:q.id, correct:isCorrect});
            }
            const pct = Math.round((correct/questions.length)*100);
            return {correct, total:questions.length, pct, detail};
        }

        function addField(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }

        function submitExam(){
            // validar nombre
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('accessCode').value.trim();
            if(!name || !code){alert('Ingresa tu nombre/matrícula Y tu código de especialidad antes de enviar');return}

            const answers = gatherAnswers(currentQuestions);
            // si alguna no contestada -> confirmar
            const anyUnanswered = answers.some(a=>a.chosen===null);
            if(anyUnanswered){ if(!confirm('Hay preguntas sin responder. ¿Deseas enviar de todos modos?')) return }

            const score = computeScore(currentQuestions, answers);
            
            // MOSTRAR RESULTADO AL ALUMNO
            resultDiv.style.display='block';
            resultDiv.innerHTML = `<h3>Resultado</h3>
                <p>Correctas: ${score.correct} / ${score.total}</p>
                <p>Porcentaje: ${score.pct}%</p>
                <p class="small">Se ha guardado tu examen. Si tienes dudas, avisa a tu profesor.</p>`;

            // PREPARACIÓN DEL MÉTODO ANTI-CORS (Formulario POST oculto)
            status.textContent = 'Guardando resultado... (Espera un momento, el guardado está en curso...)';

            // 1. Crear formulario dinámico
            const dataForm = document.createElement('form');
            dataForm.target = 'hiddenIframe'; 
            dataForm.method = 'POST';
            dataForm.action = GAS_WEBAPP_URL; 
            
            // 2. Adjuntar campos (NOTA: Los nombres deben coincidir con e.parameter en el Apps Script)
            addField(dataForm, 'student', name);
            addField(dataForm, 'accessCode', code); // Campo de especialidad
            addField(dataForm, 'score', score.pct);
            addField(dataForm, 'correct', score.correct);
            addField(dataForm, 'total', score.total);
            addField(dataForm, 'details', JSON.stringify(score.detail)); // JSON como texto

            // 3. Añadir el formulario al DOM y enviarlo
            document.body.appendChild(dataForm);
            dataForm.submit();
            
            // Finalizar el estado
            setTimeout(() => {
                status.textContent = '✅ ¡Guardado de datos finalizado correctamente! (Revisa tu hoja de cálculo)';
                dataForm.remove(); 
            }, 3000); 

            // Bloquear el form para evitar reenvíos accidentales
            examForm.querySelectorAll('input').forEach(i=>i.disabled=true);
            document.getElementById('studentName').disabled = true;
            document.getElementById('accessCode').disabled = true;
        }

        let currentQuestions = [];
        startBtn.addEventListener('click', ()=>{
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('accessCode').value.trim();
            if(!name || !code){ alert('Ingresa tu nombre/matrícula Y tu código de especialidad antes de iniciar'); return }

            // seleccionar preguntas
            currentQuestions = selectRandomQuestions(QUESTIONS, TOTAL_PER_EXAM);
            renderExam(currentQuestions);
            // ocultar boton
            startBtn.disabled=true; startBtn.textContent='Examen iniciado';
            status.textContent = `Examen cargado (${currentQuestions.length} preguntas). Buena suerte.`;
            // si se desea tiempo, arrancar cuenta regresiva
            if(TIME_LIMIT_MINUTES>0){ startTimer(TIME_LIMIT_MINUTES*60) }
        });

        // temporizador (opcional)
        function startTimer(seconds){
            const timerDiv = document.createElement('div'); timerDiv.className='small card';
            examForm.prepend(timerDiv);
            let s=seconds; const iv = setInterval(()=>{
                const m=Math.floor(s/60); const sec=s%60; timerDiv.textContent = `Tiempo restante: ${m}:${sec.toString().padStart(2,'0')}`;
                if(s<=0){ clearInterval(iv); alert('Tiempo terminado. El examen se enviará automáticamente.'); submitExam(); }
                s--; },1000);
        }

    </script>
</body>
</html>